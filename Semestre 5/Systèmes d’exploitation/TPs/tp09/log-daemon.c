#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>
#include <limits.h>

int main(int argc, char const *argv[]){
    int fdlogger = mkfifo("/tmp/logger" , 0622); 
    int fdmylogger = open("/tmp/my-logs" , O_CREAT | O_WRONLY | O_APPEND , 0644) ; 
    char buff[PIPE_BUF] ; 
    pid_t pid ; 
    size_t sz ; 
    while (1){
        fdlogger = open("/tmp/logger" , O_RDONLY) ; 
        ssize_t rd = read(fdlogger , buff , PIPE_BUF); 
        if (rd < 0) {
            perror("error read") ; 
            close(fdlogger) ; 
            continue;
        }
        if (rd == 0) {
            printf("no message read") ;
            close(fdlogger) ; 
            continue;
        }
        memmove(&pid , buff , sizeof(pid_t)) ; 
        memmove(&sz , buff+sizeof(pid_t) , sizeof(size_t)) ; 
        char tmp[BUFSIZ] ;  
        sprintf(tmp , "date %s --- pid %d --- " , __DATE__ , pid) ;
        memmove(tmp+strlen(tmp) , buff+sizeof(pid_t)+sizeof(size_t) , sz) ;
        memmove(tmp+strlen(tmp) , "\n" , sizeof(char)) ; 
        ssize_t wr = write(fdmylogger , tmp , strlen(tmp)) ;  
         
    }
    
    return 0;
}
