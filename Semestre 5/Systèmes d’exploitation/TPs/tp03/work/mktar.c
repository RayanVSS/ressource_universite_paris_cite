#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <libgen.h>
#include <sys/param.h>
#include "tarutils.h"

char zeros[BLOCKSIZE] = {0};
char buf[BLOCKSIZE];
struct posix_header hd;


/* ajoute un fichier de nom filename à l'archive ouverte (fd)
 * retourne 0 en cas de succès, 1 en cas d'échec */
int tar_one_file(int fd, char * filename) {
  struct stat st; 
  struct posix_header * phd = &hd;

  /* TODO : création de l'entête; commencer par le remplir de 0, puis
   * renseigner au moins les champs indispensables : typeflag, name,
   * mode, size, et _en dernier_ checksum.  
   * Pour typeflag, mode et size, utiliser stat() */

  // memset(phd->name , '\0' , 100) ; 
  // memset(phd->mode , '\0' , 8) ; 
  // memset(phd->size , '\0' , 12) ; 

  memset(phd , '\0' , BLOCKSIZE) ; 
  
  memcpy(phd->name , filename , strlen(filename)) ; 
  if (stat(filename , &st) == -1) return 1 ; 
  snprintf(phd->mode , 8 , "%07o" , st.st_mode);
  snprintf(phd->size , 12 , "%011lo" , st.st_size) ; 
  phd->typeflag = '0' ; 


  /* calcul de checksum : indispensable pour gnu tar :-( */
  set_checksum(phd);

  /* TODO : ouverture du fichier à copier */
  int fd_cp = open(filename , O_RDONLY) ; 
  if (fd_cp < 0) {
    return 1 ; 
  }
  /* TODO : copie de l'entête dans l'archive */
  int write_val = write(fd , phd , BLOCKSIZE) ; 
  if (write_val != BLOCKSIZE) {
    close(fd_cp) ; 
    return 1 ; 
  }

  /* TODO : copie du fichier; ATTENTION à compléter le dernier bloc si
   * nécessaire */
  int read_val = 0 ; 
  while ((read_val = read(fd_cp , buf , MIN(BLOCKSIZE , st.st_size))) != 0){
    write_val = write(fd , buf , read_val) ; 
    if (write_val != read_val) {
      close(fd_cp) ; 
      return 1 ; 
    }
    st.st_size -= read_val ; 
    if (write_val < BLOCKSIZE) {
      write(fd , "\0" , BLOCKSIZE-write_val) ; 
    }
  }
  /* TODO : fermeture du fichier copié */
  close(fd_cp) ; 
  return 0;
}



int main(int argc, char **argv){
  if (argc < 3) {
    fprintf(stderr, "Usage : %s file.tar f1 [... fn]\n", argv[0]);
    exit(1);
  }

  /* TODO : création du fichier d'archive */
  int fd = open(argv[1] , O_CREAT | O_RDWR , 0664) ; 

  /* TODO : boucle principale pour ajouter chaque argv[i] l'un après
   * l'autre */
  for (char ** i = argv+2 ; i < argv+argc ; i++) {
    if (tar_one_file(fd , *i)) {
      close(fd) ; 
      exit(1) ; 
    }
  }

  /* TODO : finalisation : ajout de deux blocs vides */
  for (int i = 0 ; i<2 ; i++) {
    int write_val = write(fd , zeros , BLOCKSIZE) ; 
    if (write_val != BLOCKSIZE) {
      close(fd) ; 
      exit(1) ; 
    }
  }
  /* TODO : fermeture du fichier tar */
  close(fd) ; 
  exit(0);
}
