#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <signal.h>
#include <sys/wait.h>
#include <sys/types.h>
#include <errno.h>
#include <dirent.h>
#include <sys/stat.h>
#include <fcntl.h>


int count (char * str , size_t size) {
    int nb = 0 ; 
    for (size_t i = 0 ; i<size ; i++) {
        if (str[i] == '\n') nb++ ;
    }
    return nb ; 
}

int main(int argc, char const *argv[]){
    int fd = -1 ; 
    pid_t pid = fork();
    switch (pid) {
        case 0:
            fd = open("log.txt" , O_WRONLY | O_CREAT | O_TRUNC , 0644);
            dup2(fd , STDERR_FILENO);
            close(STDOUT_FILENO);
            execlp("strace" , "strace" , argv[1] , NULL);
            perror("execlp");
            exit(EXIT_FAILURE);
            break;
        case -1:
            perror("fork");
            exit(EXIT_FAILURE);
        default:
            wait(NULL);
            int nb = 0 ; 
            char buffer[BUFSIZ] = {0};
            fd = open("log.txt" , O_RDONLY);
            size_t rd ;
            while((rd = read(fd , buffer , BUFSIZ)) > 0) {
                nb += count(buffer , rd);
                memset(buffer , 0 , BUFSIZ);
            }
            printf("nb = %d\n" , nb-1);
            break;    
    }
    return 0;
}
