#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

char *pere = "\033[34m[pere]\033[m";
char *fils = "\033[32m[fils]\033[m";

int M = 100;

int main() {
  int n = 1000;

  /* valeurs initiales (avant clonage) */
  printf("%s adresse de M : %p\n", pere, &M);
  printf("%s adresse de n : %p\n", pere, &n);
  printf("%s valeur de M et de n : %d %d\n", pere, M, n);

  /* clonage */
  switch (fork()) {
    case -1 : /* cas d'erreur */
      exit(2);

    case 0 : /* code du fils */
      /* tout est identique au père */
      printf("%s adresse de M : %p\n", fils, &M);
      printf("%s adresse de n : %p\n", fils, &n);
      printf("%s valeur de M et de n : %d %d\n", fils, M, n);

      /* modifications des variables du fils */
      M *= 2; n*= 2;
      printf("%s ------ multiplication par 2 ------\n", fils);
      printf("%s valeur de M et de n : %d %d\n", fils, M, n);

      /* pause pendant que le père réalise ses modifications */
      sleep(2);

      /* les modifications du père n'ont pas modifié les variables du
       * fils */
      printf("%s valeur de M et de n : %d %d\n", fils, M, n);

      /* sortie du switch */
      break;

    default : /* code du père */
      /* pause pendant que le fils réalise ses modifications */
      sleep(1);

      /* les modifications du fils n'ont pas modifié les variables du
       * père */
      printf("%s valeur de M et de n : %d %d\n", pere, M, n);

      /* modifications des variables du père */
      M *= 3; n*= 3;
      printf("%s ------ multiplication par 3 ------\n", pere);
      printf("%s valeur de M et de n : %d %d\n", pere, M, n);

      /* pause jusqu'à ce que le fils termine */
      wait(NULL);
  }

  return 0;
}
